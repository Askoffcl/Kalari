{% extends "layout.html" %}
{% block messages %}{% endblock %}  <!-- Disable toast messages -->

{% block content %}
<style>
    body {
        background-color: #d6dfdf;
    }
    .chat-box {
        scrollbar-width: thin;
        scrollbar-color: #888 #f5f5f5;
    }
    .chat-box::-webkit-scrollbar {
        width: 8px;
    }
    .chat-box::-webkit-scrollbar-thumb {
        background-color: #888;
        border-radius: 4px;
    }
</style>

<div class="container" style="margin-top: 100px; max-width: 800px;">

  <!-- Back Button -->
  <div class="mb-3">
    <a href="{% url 'my_class' %}" class="btn btn-outline-primary">
      ‚Üê Back to Classes
    </a>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="text-center mb-0">üí¨ Chat - {{ class_obj.name }}</h3>

    {% if request.user.role == 'teacher' %}
    <!-- Clear Chat Button -->
    <form method="POST" action="{% url 'clear_chat' class_obj.id %}" onsubmit="return confirm('Are you sure you want to clear all messages?');">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è Clear Chat</button>
    </form>
    {% endif %}
  </div>

  <!-- Chat Box -->
  <div class="chat-box border rounded shadow-sm p-3 mb-3" style="height: 450px; overflow-y: auto; background: #f5f5f5;">
    {% for msg in messages %}
      <div class="d-flex mb-2 {% if msg.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %}">
        <div class="p-3 rounded-3 position-relative"
             style="max-width: 70%; word-wrap: break-word;
                    {% if msg.sender == request.user %}background-color: #0d6efd; color: #fff;{% else %}background-color: #e9ecef; color: #212529;{% endif %}; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
          
          <!-- Role badge -->
          {% if msg.sender.role %}
            <span class="badge position-absolute top-0 start-0 translate-middle-y"
                  style="font-size: 0.65rem;
                         {% if msg.sender.role == 'teacher' %}background-color: #ffc107; color: #212529;{% else %}background-color: #0dcaf0; color: #212529;{% endif %}">
              {{ msg.sender.role|title }}
            </span>
          {% endif %}

          <!-- Sender name -->
          <div class="small mb-1"><strong>{{ msg.sender.username }}</strong></div>
          
          <!-- Message -->
          <div>{{ msg.message }}</div>

          <!-- Timestamp -->
          <div class="text-end text-muted small mt-1">{{ msg.timestamp|date:"d-m-Y H:i" }}</div>
        </div>
      </div>
    {% empty %}
      <p class="text-center text-muted mt-5">No messages yet. Start the conversation!</p>
    {% endfor %}
  </div>

  <!-- Message Input -->
  <form method="POST" class="d-flex gap-2">
    {% csrf_token %}
    <input type="text" name="message" class="form-control rounded-pill shadow-sm" placeholder="Type a message..." required>
    <button class="btn btn-primary rounded-pill px-4 shadow-sm" type="submit">Send</button>
  </form>

</div>

<!-- Auto-scroll to bottom -->
<script>
  const chatBox = document.querySelector('.chat-box');
  chatBox.scrollTop = chatBox.scrollHeight;
</script>
{% endblock %}
